require_relative "../../lib/c64"

describe C64::ProgramExtensions do

  describe "end-to-end" do
    it "hello world" do
      prg = R65::Program.new do
        call C64::Macros::Bootstrap do
          ldx &0
          label :loop do
            lda :msg,:x
            cmp &"#".to_scr.first
            beq :done
            sta 0x400,:x
            inx
            jmp :loop
          end
          label :done
          rti
        end
        label :msg
        byte "HELLO WORLD!#".to_scr
      end

      expected = [
        0x01,0x08,0x0c,0x08,0x0a,0x00,0x9e,0x32,
        0x30,0x36,0x32,0x00,0x00,0x00,0x00,0xa2,
        0x00,0xbd,0x1f,0x08,0xc9,0x23,0xf0,0x07,
        0x9d,0x00,0x04,0xe8,0x4c,0x10,0x08,0x40,
        0x08,0x05,0x0c,0x0c,0x0f,0x20,0x17,0x0f,
        0x12,0x0c,0x04,0x21,0x23
      ]
      expect(prg.as_bytes).to eq expected
    end

  end

end
